<!-- emulate the hosting environment  -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.1/css/bootstrap.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" />
<script src="https://ajax.aspnetcdn.com/ajax/jquery/jquery-3.2.1.min.js"></script>
<script>$vm={};$VmAPI={};$vm.ver=[3,3];</script>
<div id=content></div>
<div system-html>
    <div alert class="modal fade" id="vm_alert_information" tabindex="-1" role="dialog" aria-labelledby="vm_dialog" aria-hidden="true" data-backdrop="static">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="ModalLabel">Information</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
</div>


<script>
	//------------------------------------
    $vm.start_time=new Date().getTime();
    $vm.api_path_development="https://cbs.wappsystem.com/dev/";
    $vm.api_path_production="https://cbs.wappsystem.com/dev/";
    $vm.default_production="No";
    $vm.qid='10000000';
    $vm.vm_router=undefined;
    $vm.module_start_id=2;
    //------------------------------------
    $vm.start=function(){
        $vm.module_list={}
        for(p in _module_list){
            $vm.module_list[p]=_module_list[p];
        }
        $vm.init_v3({callback:function(){
            var module_txt=$('#D__ID').html();
            $('#D__ID').remove();
            $vm.hosting_path=window.location.href.substring(0, window.location.href.lastIndexOf('/')).split('\/?')[0];
    		localStorage.setItem($vm.hosting_path+"-local_txt",module_txt);
    		localStorage.setItem($vm.hosting_path+"-local_ver",$vm.version);
            $vm.root_layout_content_slot="content";
            $vm.url=function(text){ return text.replace(/__COMPONENT__\//g,'https://component.vmiis.com/'); }
            $vm.load_module_v2('the-module','',{})
        }});
    }
    $vm._start=function(){
        //------------------------------------------
        var data=''; for(var key in window.localStorage){ if(window.localStorage.hasOwnProperty(key)){ data+=window.localStorage[key]; }}
        if(data.length>3000000) localStorage.clear();
        //------------------------------------------
        $vm.vm={}; $vm.version=$vm.ver[0]; $vm.reload='';
        $vm.hosting_path=window.location.href.substring(0, window.location.href.lastIndexOf('/')).split('\/?')[0];
        $vm.debug_message=true; //show debug message in console
        //------------------------------------------
        if($vm.default_production=='No'){
            if(window.location.toString().indexOf('database=production')!=-1){
                $vm.server          ='production';
                $VmAPI.api_base     =$vm.api_path_production;
            }
            else{
                $vm.server          ='development';
                $VmAPI.api_base     =$vm.api_path_development;
            }
        }
        else {
            if(window.location.toString().indexOf('database=development')!=-1){
                $vm.server          ='development';
                $VmAPI.api_base     =$vm.api_path_development;
            }
            else{
                $vm.server          ='production';
                $VmAPI.api_base     =$vm.api_path_production;
            }
        }
        //------------------------------------------
        $vm.show_user=function(){
            var third=""
            if($vm.user_puid=="1") third=" (Google)";
            if($vm.user_puid=="2") third=" (Facebook)";
            if($vm.user=='guest'){
                $('#vm_username').text('');
                $('#vm_signin').removeClass('vm-hide');
                $('#vm_signout').addClass('vm-hide');
            }
            else{
                $('#vm_username').text('Signed in as '+ $vm.user+third);
                $('#vm_signin').addClass('vm-hide');
                $('#vm_signout').removeClass('vm-hide');
            }
        }
        //---------------------------------------------
        window.onmessage=function(e){
            if(e.data.username!=undefined && e.data.user_id!=undefined){
                $vm.user=e.data.username;
                $vm.user_id=e.data.user_id;
                $VmAPI.set_token(e.data.token,e.data.api_url,e.data.username,e.data.user_id,e.data.nickname);
                location.reload(true);
            }
        };
        //------------------------------------
        $vm.load_resources=function(links){
            for(i in links){
                var e=links[i].split('.').pop();
                if(e=='css'){
                    $('head').append("<link rel='stylesheet' href='"+links[i]+"'>");
                }
                else if(e=='js'){
                    $vm.load_js_link(links[i])
                }
            }
            //-------------------------------------
            $vm.module_list['_system_export_dialog_module']={table_id:'',url:'__COMPONENT__/dialog/export_dialog_module.html',"name_for_search":""};
            $vm.module_list['_system_import_dialog_module']={table_id:'',url:'__COMPONENT__/dialog/import_dialog_module.html',"name_for_search":""};
            $vm.module_list['uploading_file_dialog_module']={table_id:'',url:'__COMPONENT__/dialog/uploading_file_dialog_module.html',"name_for_search":""};
            $vm.load_module_v2('_system_export_dialog_module','hidden',{})
            $vm.load_module_v2('_system_import_dialog_module','hidden',{})
            $vm.load_module_v2('uploading_file_dialog_module','hidden',{})
            //-------------------------------------
        }
        //------------------------------------
        setTimeout(function (){ $.ajaxSetup({cache:true}); $vm.load_resources($vm.resources); },10);
        //------------------------------------
        $vm.load_js_link=function(link){
            $.getScript(link,function(){
                var nm=link.split('/').pop();
                nm=nm.replace(/\./g,'-');
                $vm[nm]=1;
                if(nm=='loader-js'){
                    google.charts.load('current', {packages: ['corechart']});
                }
            });
        }
        //------------------------------------
        $vm.alert=function(msg){
          $('#vm_alert_information div.modal-body').html( $('<div/>').html(msg).text() );
          $("#vm_alert_information").modal();
        }
        //------------------------------------
        $vm.close_alert=function(){
          $('#vm_alert_information').modal('hide');
        }
        //------------------------------------
        if($vm.server!='production') $('#vm_system_info').text((new Date().getTime()-$vm.start_time).toString()+"ms")
        $vm.app_module=1;
        //------------------------------------
        var set_height=function(){
            var header_height=0;
            var footer_height=0;
            $vm.min_height=($('body').height()-header_height-footer_height);
        }
        //------------------------------------
        set_height();window.onresize=function(){set_height();}
        //-----------------------------------------
    }
    //------------------------------------
    $vm._I=0; $vm._boot=function(){
        $vm._I++;
        if($vm._I==2){
            $vm._id=$vm.module_start_id-1;
            $vm._start(); $vm.start();
        }
    }
    //------------------------------------------
    $vm.url=function(text){
        //replace some text in old modules to the correct ones
        text=text.replace(/__HOST__\//g,$vm.hosting_path+'/');
        text=text.replace(/__VER__/g,$vm.ver[0]);
        text=text.replace(/__PARTS__\//g,'__COMPONENT__/');
        text=text.replace(/__COMPONENT__\//g,'https://component.vmiis.com/');
        if(window.location.toString().indexOf('_d=1')!=-1){
            //use local system files
            var host=window.location.protocol+'//'+window.location.host;
            text=text.replace(/https:\/\/api.vmiis.com/g,host+'/vmiis/api-2');
            text=text.replace(/https:\/\/framework.vmiis.com/g,host+'/vmiis/framework-2');
            text=text.replace(/https:\/\/component.vmiis.com/g,host+'/vmiis/component-2');
        }
        return text;
    }
    //---------------------------------------------
    var url1=$vm.url("https://framework.vmiis.com/distribution/vmframework.min.js");
    var url2=$vm.url("https://api.vmiis.com/distribution/vmapi.min.js");
    var urls=[url1,url2];
    //---------------------------------------------
    $(urls).each(function(index,url){
        var ver=localStorage.getItem(url+"ver");
        var txt=localStorage.getItem(url+"txt");
        if(ver!=$vm.ver[1] || txt==null || window.location.toString().indexOf('_d=1')!=-1){
            $.get(url+'?_='+new Date().getTime(),function(new_txt){
                localStorage.setItem(url+"txt",new_txt);
                localStorage.setItem(url+"ver",$vm.ver[0]);
                console.log('loading from url. '+url);
                $('head').append('<scr'+'ipt>'+new_txt+'</scr'+'ipt>');
                $vm._boot();
            },'text');
        }
        else{
            console.log('loading from storage. '+url);
            $('head').append('<scr'+'ipt>'+txt+'</scr'+'ipt>');
            $vm._boot();
        }
        //---------------------------------------------
    })
    //---------------------------------------------
</script>
<style>
    html,body{
        margin:0;padding:0;height:100%;font-family:Arial;
    }
</style>
