<section>
	<div id=toolbar__ID class="navbar navbar-default">
	    	<div id=row_1__ID class="col-sm _col-lg-4 form-inline">
		        	<button id=new__ID  type=button class='btn btn-secondary' ><i class="fa fa-plus" title='New'></i></button>
		        	<button id=save__ID type=button class='btn btn-secondary'><i class="fa fa-upload" title='Save'></i></button>
					<input id=keyword__ID type="text" placeholder="keyword" class="form-control" style="width: 150px; display:inline-block;">
                    <input id=department__ID type=text placeholder='Department' class="form-control" style="width: 150px; display:inline-block;"></input>
					<button id=query__ID type=button class="btn btn-secondary"><i class="fa fa-search" title='Search'></i></button>
	    	</div>
	    	<div class="col-sm _col-lg-4 form-inline">
		            Page Size:
		            <select id=page_size__ID class="form-control" style='margin-right:20px;display:inline-block;width:auto;'><option>30</option><option>50</option><option>100</option><option>200</option></select>
		            <span id=I__ID style="display:none">0</span><span id=A__ID></span>
		            <button id=p__ID type=button class="btn btn-secondary"><i class="fa fa-arrow-left"></i></button>
		            <button id=n__ID type=button class="btn btn-secondary"><i class="fa fa-arrow-right"></i></button>
	    	</div>
	       	<span id=elapsed__ID style='float:right'></span>
    </div>
    <div id=table__ID>
        <table id=grid__ID></table>
    </div>
</section>
<style>
	#toolbar__ID{
		background-color:#ccc;
		padding:5px 0px;
		margin-bottom:0px;
		overflow:hidden
	}
	#toolbar__ID *{
		margin-right:3px;
	}
	@media screen and (max-width:768px){
		#toolbar__ID{
			padding: 3px 0;
		}
		#toolbar__ID div{
			padding-left:3px;
		}
		#row_1__ID{
			padding-bottom: 3px;
		}
	}
</style>
<script>
    function F__ID(){
        //-------------------------------------
        VmInclude:__COMPONENT__/grid/grid.v3.js
        //-------------------------------------
        var fields="Photo,_More,Title,First_Name,Last_Name,Gender,Department,Position,Location,Email,Phone,Login_Name";
        _fields="_Form,"+fields+",Submit Date|DateTime,Submitted by|Author,_Delete";
        //-------------------------------------
        if($vm.user=='guest') _fields=_fields.replace(',_Delete','');
        //-------------------------------------
        $('#D__ID').on('load',function(){ _set_req(); _request_data(); })
        //-------------------------------------
        var prefix=$vm.module_list[$vm.vm["__ID"].name].prefix;
		var department_tid=$vm.module_list[prefix+"department"].table_id;
		//-------------------------------------
		$('#department__ID').autocomplete({
            minLength:0,
            source:function(request,response){
                var sql="with tb as (select name=S1 from [TABLE-"+department_tid+"])";
                sql+=" select top 10 name,value=name from tb where name like '%'+@S1+'%' ";
                $VmAPI.request({data:{cmd:'auto',s1:request.term,sql:sql,minLength:0},callback:function(res){
                    response($vm.autocomplete_list(res.table));
                }});
            },
        })
        $('#department__ID').focus(function(){$('#department__ID').autocomplete("search","");});
        //-------------------------------------
        _cell_render=function(records,I,field,td,set_value,source){
            switch(field){
				case '_More':
                    records[I].vm_custom[field]=true;
                    if(records[I].UID===undefined) return;
                    td.html("<u style='cursor:pointer'>More...</u>");
                    td.find('u').on('click',function(){
                        $vm.nav_load_module('staff-management-child',$vm.root_layout_content_slot,{record:records[I]});
                    });
                    break;
                    break;
                case 'Photo':
                    VmInclude:__COMPONENT__/grid/field_image.js
                break;
                case 'Gender':
                    VmInclude:__COMPONENT__/grid/field_gender.js
                break;
                case 'Department':
                    var sql="with tb as (select distinct name=S1,UID from [TABLE-"+department_tid+"]) select name, value=name,value2=UID from tb where name like '%'+@S1+'%' ";
                    VmInclude:__COMPONENT__/grid/field_auto.js
                break;
            }
        }
        //-------------------------------------
        _before_submit=function(record,dbv){
            dbv.S1=record.Department;
            dbv.S2=record.Login_Name;
            dbv.S3=record.First_Name+" "+record.Last_Name;
            return true;
        };
        //-------------------------------------
        _new_pre_data_process=function(){
            _records[0].Department=$('#department__ID').val();
        };
        //-------------------------------------
		_set_req=function(){
            var single_record=$vm.module_list[$vm.vm["__ID"].name].single_record;
            if(single_record=="1"){
                var input=$vm.vm['__ID'].op.input;
				var where="S2='"+input.record.Login_Name+"'";
	            var sql="select ID,Information,DateTime,Author from [TABLE-"+_db_pid+"] where "+where;
	            _req={cmd:'query_records',sql:sql}
			}
			else{
				var where=" S1 like '%'+@S2+'%' "
				var sql="with tb as (select S1,S2,Information,PID,ID,UID,PUID,DateTime,Author,Modified,RowNum=row_number() over (order by ID DESC) from [TABLE-"+_db_pid+"-@S1] where "+where+")";
				sql+="select S1,S2,Information,PID,ID,UID,PUID,DateTime,Author,Modified,RowNum from tb where RowNum between @I6 and @I7";
				var sql_n="select count(ID) from [TABLE-"+_db_pid+"-@S1] where "+where;
				_req={cmd:'query_records',sql:sql,sql_n:sql_n,s1:'"'+$('#keyword__ID').val()+'"',s2:$('#department__ID').val(),I:$('#I__ID').text(),page_size:$('#page_size__ID').val()}
			}
		}
		//-------------------------------------
        _data_process_after_render=function(){
            var single_record=$vm.module_list[$vm.vm["__ID"].name].single_record;
            if(single_record=="1"){
                if(_records.length==1){
                    var form=$('#grid__ID tr:nth-child(2)').find('u:first');
                    form.triggerHandler('click');
                }
                else{
                    alert("More than one records were found! Please report the administrator.");
                    return;
                }
            }
        }
        //-------------------------------------
    }
</script>
<style>
    VmInclude:__COMPONENT__/grid/grid.v3.css
</style>
