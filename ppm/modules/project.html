<section>
    <div style='background-color:#bbb;display:flex;padding:6px 0 6px 16px'>
        <span id=parent__ID></span>
    </div>
      VmInclude:__COMPONENT__/grid/grid.v3.html
</section>
<script>
    function F__ID(){
        //-------------------------------------
        VmInclude:__COMPONENT__/grid/grid.v3.js
        _json=''; //Store data as XML - NOT json
        //-------------------------------------
        var prefix=$vm.module_list[$vm.vm['__ID'].name].prefix;
        var input;
        //-------------------------------------
        _fields="_Form,_Project_Documents,_Proposal_and_Variation,_Actual_Spending,_Pending_Fund,Project,Code|Project_Code,Country,Description";
        _fields+=",_gridHidden|Theme,Primary Sector|Sector,_gridHidden|Secondary_Sector,_gridHidden|Implementation_Arrangement";
        _fields+=",_gridHidden|DRR_Mainstreaming,Start,End,Status|Project_Status,_Hidden|DAC_codes_primary,_Hidden|DAC_codes_secondary,Location";
        _fields+=",_gridHidden|Location_2,_gridHidden|Location_3,_gridHidden|Location_4,Approval_Status,Approval_Date,_gridHidden|List_people_updated";
        _fields+=",_gridHidden|New_Comments,Comments,_gridHidden|Creation_Date,_gridHidden|Created_By,Request_Fund,Requested_amount";
        _fields+=",Submit Date|DateTime,Submitted by|Author,_Delete";
        //-------------------------------------
        var approved=true;
        var projectcode=true;
        var projectcode_value="";
        var projectstatus=true;
        var requestfund="";
        var requestfundconfirm="";
        //-------------------------------------
        _cell_render=function(records,I,field,td,set_value,source){
            switch(field){
                case '_Proposal_and_Variation':
                    records[I].vm_custom[field]=true;
                    if(_records[I].UID===undefined) return;
                    td.html("<u style='cursor:pointer'>Proposal</u>");
                    td.find('u').on('click',function(){
                        $vm.load_module_by_name("panel_main_proposal_and_variation",$vm.root_layout_content_slot,{
                            //------------------------
                            mobj:_mobj,
                            record:records[I],
                            puid:records[I].UID,
                            sys:{},
                            ppid:_db_pid,
                            //------------------------
							parent_uid:records[I].UID,
							child:"1",
                            check_count_where:" and PUID="+records[I].UID,
                            program_code:_mobj.op.program_code,
                            project_code:records[I].Project_Code,
                        })
                        //-----------------------------------------------
                    });
                	break;
                case '_Project_Documents':
                    records[I].vm_custom[field]=true;
                    if(_records[I].UID===undefined) return;
                    td.html("<u style='cursor:pointer'>Documents</u>");
                    td.find('u').on('click',function(){
                        $vm.load_module_by_name("panel_main_project_document",$vm.root_layout_content_slot,{
                            //------------------------
                            mobj:_mobj,
                            record:records[I],
                            puid:records[I].UID,
                            sys:{},
                            ppid:_db_pid,
                            //------------------------
							parent_uid:records[I].UID,
							child:"1",
                            check_count_where:" and PUID="+records[I].UID,
                            program_code:_mobj.op.program_code,
                            project_code:records[I].Project_Code,
                        })
                        //-----------------------------------------------
                    });
                	break;
                case 'Approval_Date':
                case 'Creation_Date':
                    VmInclude:__COMPONENT__/grid/field_date.js
                    break;
                case 'Start':
                case 'End':
                    records[I].vm_custom[field]=true;
                    td.html('<input style="border:0; width:80px" />')
                    td.find('input').val(records[I][field])
                    var dateFormat='M yy';
                    td.find('input').datepicker({dateFormat:dateFormat,changeMonth:true,changeYear:true,onClose:function(dateText) {
                        set_value(dateText,records,I,field);
                    }});
                    break;
                case 'Comments':
                    records[I].vm_readonly[field]=true;
                    td.html(records[I][field]);
                    break;
                case 'Project_Status':
                    var html="<select style='border:0;''>\
                    <option value='' ></option>\
                    <option >Open</option>\
                    <option >Closed</option>\
                    </select>\
                    ";
                    VmInclude:__COMPONENT__/grid/field_select.js
                    break;
                case 'Request_Fund':
                    td.html('<input type=checkbox />');
                    VmInclude:__COMPONENT__/grid/field_checkbox.js
                    break;
                case 'Country':
                    var sql="with tb as (select name=@('Country') from [TABLE-"+$vm.module_list[prefix+'country'].table_id+"] where LEN(@('Country'))<30)";
                    sql+=" select top 10 name,value=name from tb where name like '%'+@S1+'%' order by name ";
                    VmInclude:__COMPONENT__/grid/field_auto.js
                    break;
                case 'DocProgram':
                    VmInclude:__COMPONENT__/grid/field_file.js
                	break;
                case 'Sector':
                case 'Secondary_Sector':
                    var sql="with tb as (select name=@('Sector') from [TABLE-"+$vm.module_list[prefix+'sector'].table_id+"] where LEN(@('Sector'))<20)";
                    sql+=" select top 10 name,value=name from tb where name like '%'+@S1+'%' ";
                    VmInclude:__COMPONENT__/grid/field_auto.js
                    break;
                case 'Approval_Status':
                    var sql="with tb as (select name=@('Approval_Status') from [TABLE-"+$vm.module_list[prefix+'approval_status'].table_id+"] )";
                    sql+=" select top 10 name,value=name from tb where name like '%'+@S1+'%' ";
                    VmInclude:__COMPONENT__/grid/field_auto.js
                    break;
                case 'Implementation_Arrangement':
                    var sql="with tb as (select name=@('Implementation_Arrangement') from [TABLE-"+$vm.module_list[prefix+'implementation_arrangement'].table_id+"] )";
                    sql+=" select top 10 name,value=name from tb where name like '%'+@S1+'%' ";
                    VmInclude:__COMPONENT__/grid/field_auto.js
                    break;
                case 'DRR_Mainstreaming':
                    var sql="with tb as (select name=@('DRR_Mainstreaming') from [TABLE-"+$vm.module_list[prefix+'drr_mainstreaming'].table_id+"] )";
                    sql+=" select top 10 name,value=name from tb where name like '%'+@S1+'%' ";
                    VmInclude:__COMPONENT__/grid/field_auto.js
                    break;
                case 'Theme':
                    var sql="with tb as (select name=@('Theme') from [TABLE-"+$vm.module_list[prefix+'theme'].table_id+"] )";
                    sql+=" select top 10 name,value=name from tb where name like '%'+@S1+'%' ";
                    VmInclude:__COMPONENT__/grid/field_auto.js
                    break;
                case 'Location':
                case 'Location_2':
                case 'Location_3':
                case 'Location_4':
                    var sql="with tb as (select name=@('Location') from [TABLE-"+$vm.module_list[prefix+'location'].table_id+"] )";
                    sql+=" select top 10 name,value=name from tb where name like '%'+@S1+'%' ";
                    VmInclude:__COMPONENT__/grid/field_auto.js
                    break;

            }
        }
        //-------------------------------------
        $('#D__ID').on('load',function(){
            input=$vm.vm['__ID'].op.input;
            var title='Programme Code: '+input.record.Code+' | ('+input.status+') Projects';
            $('#parent__ID').text(title);
            _set_req(); _request_data();  })
        //-------------------------------------
        var _set_req=_set_req_export=function(){
            var status=" and @('Project_Status') <> 'Closed'";
            if(input.status=="closed" ) status=" and @('Project_Status') = 'Closed'";
            var sql="with tb as (select Information,B1,ID,UID,PUID,DateTime,Author,RowNum=row_number() over (order by ID DESC) from [TABLE-"+_db_pid+"-@S1] where PUID=@I2 "+status+" ) ";
            sql+="select Information,B1,ID,UID,PUID,DateTime,Author,RowNum from tb where RowNum between @I6 and @I7";
            var sql_n="select count(ID) from [TABLE-"+_db_pid+"-@S1] where PUID=@I2 "+status+"";
            _req={cmd:'query_records',db_pid:_db_pid,sql:sql,sql_n:sql_n,i2:input.record.UID,s1:'"'+$('#keyword__ID').val()+'"',I:$('#I__ID').text(),page_size:$('#page_size__ID').val()}
        }
        //-------------------------------------
        _before_change=function(records,I,field,td,set_value,source){
            switch(field){
                case 'Project_Status':
                    if(records[I].Project_Status=="Open" && ($vm.user!="jojo" && $vm.user!="childfund")){
                        alert("Only Administrator can Close the Project!")
                        projectstatus=false;
                    }
                break;
                case 'Project_Code':
                    if(records[I].Project_Code!="" && ($vm.user!="jojo" && $vm.user!="childfund")){
                        alert("Only Administrator can change Project Code!")
                        projectcode=false;
                        projectcode_value=records[I].Project_Code;
                    }
                break;
                case 'Approval_Status':
                    if(records[I].Approval_Status=="PA" && ($vm.user!="jojo" && $vm.user!="childfund")){
                        alert("Only Administrator can change Approval Status when approved!")
                        approved=false;
                    }
                break;
            }
        }
        //-------------------------------------
        _after_change=function(records,I,field,td,set_value,source){
            switch(field){
                case 'New_Comments':
                    var old_comments=records[I].Comments;
                    var new_comments="<span >("+get_now()+", "+$vm.user+")</span><br>"+records[I].New_Comments+"<br>"
                    new_comments=new_comments.replace(/\n/g,'\r');
                    new_comments=new_comments.replace(/\r\r/g,'\r');
                    new_comments=new_comments.replace(/\r/g,'</br>');
                    records[I].Comments=new_comments+old_comments;
                    records[I].New_Comments="";
                break;
                case 'Project_Status':
                    if(!approved){records[I].Project_Status="Open"}
                break;
                case 'Project_Code':
                    if(!projectcode){records[I].Project_Code=projectcode_value;}
                break;
                case 'Approval_Status':
                    if(!approved){records[I].Approval_Status="PA"}
                break;
            }
        }
        //-------------------------------------
        var get_now=function(){
            var today = new Date();
            var dd = today.getDate();
            var mm = today.getMonth()+1; //January is 0!
            var yyyy = today.getFullYear();
            var hh = today.getHours();
            var min = today.getMinutes();
            if(dd<10) dd='0'+dd;
            if(mm<10) mm='0'+mm;
            if(hh<10) hh='0'+hh;
            if(min<10) min='0'+min;
            return dd+'/'+mm+'/'+yyyy+' '+hh+':'+min;
        }
        //-------------------------------------
        _before_submit=function(record,dbv){
            if(input.record.UID!=='') dbv.PUID=input.record.UID;
            dbv.PPID=input.ppid;
            return true;
        };
        //-------------------------------------

        //-------------------------------------
        var process_comments=function(){
    		if($('#New_Comments__ID').val()!==""){
    			var old_comments="";
    			if($('#Comments__ID').val()!=="") old_comments=$('#Comments__ID').val();
    			var new_comments="<span class=C20000012_light_small>("+date_to_string_dmyhm(new Date())+", "+g_user+")</span><br>"+$('#New_Comments__ID').val()+"<br>";

    			new_comments=new_comments.replace(/\n/g,'\r');
    			new_comments=new_comments.replace(/\r\r/g,'\r');
    			new_comments=new_comments.replace(/\r/g,'</br>');

    			$('#Comments__ID').val(new_comments+old_comments);
    			$('#New_Comments__ID').val('');
    		}
    	}
        //-------------------------------------

    }
</script>
<style>
    VmInclude:__COMPONENT__/grid/grid.v3.css
    .ui-datepicker-month,.ui-datepicker-year {
   color: #5c9ccc;
 }

</style>
