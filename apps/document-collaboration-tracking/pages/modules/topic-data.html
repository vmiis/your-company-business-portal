<section>
    VmInclude:__COMPONENT__/grid/grid.v3.html
</section>
<script>
    function F__ID(){
        //-------------------------------------
        VmInclude:__COMPONENT__/grid/grid.v3.js
        VmInclude:__CURRENT_PATH__/task_data.js
        //-------------------------------------
        var fields="Name,_Files,_Comments,Latest File|I2_Document,Version|I2_Version,Latest Comments|NT";
        _fields="_Form,"+fields+",Submit Date|DateTime,Submitted by|Author,_Delete,_Hidden|fileID,_Hidden|I3_Color";
        //-------------------------------------
        var file_module=this_module.file_module;
        var file_pid=this_module.file_tid;
        var comments_module=this_module.comments_module;
        var comments_pid=this_module.comments_tid;
        //-------------------------------------
        _cell_render=function(records,I,field,td,set_value,source){
            var uid=records[I].UID;
            switch(field){
                case '_Files':
                    records[I].vm_readonly[field]=true;
                    td.html("<u style='cursor:pointer'>Files</u>");
                    td.find('u').on('click',function(){
                        $vm.load_module_v2(prefix+file_module,$vm.root_layout_content_slot,{record:records[I]});
                    });
                    break;
                case '_Comments':
                    records[I].vm_readonly[field]=true;
                    td.html("<u style='cursor:pointer'>Comments</u>");
                    td.find('u').on('click',function(){
                        $vm.load_module_v2(prefix+comments_module,$vm.root_layout_content_slot,{record:records[I]});
                    });
                    break;
                case 'I2_Document':
                    records[I].vm_readonly[field]=true;
                    if(records[I][field]!=undefined){
                        td.html("<u style='cursor:pointer'>"+$vm.text(records[I][field])+"</u>");
                        td.find('u').on('click',function(){
                            $vm.open_link({rid:records[I].fileID,filename:records[I][field]});
                        });
                    }
                    break;
                case 'I2_Version':
                    records[I].vm_readonly[field]=true;
                    break;
                case 'NT':
                    records[I].vm_readonly[field]=true;
                    td.html("<span style='color:"+records[I].I3_Color+"'>"+$vm.text(records[I][field])+"</span>");
                    break;
            }
        }
        //-------------------------------------
        _set_req=function(){
            var sql_n="select count(ID) from [FORM-"+_db_pid+"-@S1]";
            var sql="with topic as (select ID,UID,Information,DateTime,Author,RowNum=row_number() over (order by ID DESC) from [FORM-"+_db_pid+"-@S1])";
            sql+="select * into #A from topic where RowNum between @I6 and @I7;";
            sql+="with topic as (select * from #A) ";
            sql+=",[file] as (select fileID=ID,filepuid=PUID,Information2=Information,F_RowNum=row_number() over (PARTITION BY PUID order by ID DESC) from [FORM-"+file_pid+"])";
            sql+=",comments as (select commentspuid=PUID,NT=S1+' ('+Author+')', Information3=Information,D_RowNum=row_number() over (PARTITION BY PUID order by ID DESC) from [FORM-"+comments_pid+"])";
            sql+=" select ID,UID,fileID,all_files=UID,NT,Information,Information2,Information3,DateTime,Author";
            sql+=" from topic left join comments on UID=commentspuid and D_RowNum=1 left join [file] on UID=filepuid and F_RowNum=1";
            _req={cmd:'query_records',sql:sql,sql_n:sql_n,s1:'"'+$('#keyword__ID').val()+'"',I:$('#I__ID').text(),page_size:$('#page_size__ID').val()}
        }
        //-------------------------------------
        _fields_e="Name,File|I2_Document,Version|I2_Version,comments|NT";
        _set_req_export=function(){
            var sql="with topic as (select ID,UID,Information,DateTime,Author,RowNum=row_number() over (order by ID DESC) from [FORM-"+_db_pid+"-@S1])";
            sql+="select * into #A from topic RRR; ";
            sql+="with topic as (select * from #A) ";
            sql+=",[file] as (select fileID=ID,filepuid=PUID,Information2=Information,F_RowNum=row_number() over (PARTITION BY PUID order by ID DESC) from [FORM-"+file_pid+"])";
            sql+=",comments as (select commentspuid=PUID,NT=S1+' ('+Author+')', Information3=Information,D_RowNum=row_number() over (PARTITION BY PUID order by ID DESC) from [FORM-"+comments_pid+"])";
            sql+=" select ID,UID,NT,Information,Information2,Information3,DateTime,Author";
            sql+=" from topic left join comments on UID=commentspuid and D_RowNum=1 left join [file] on UID=filepuid and F_RowNum=1";

            _set_from_to();
            if(_from!='0' && _to!='0') sql=sql.replace('RRR','where RowNum between @I6 and @I7');
            else sql=sql.replace('RRR','');
            _req={cmd:'query_records',sql:sql,i6:_from,i7:_to}
        }
        //-------------------------------------
        var before_submit=function(record,dbv){
            dbv.S1=record.Name;
        }
        //-------------------------------------
    }
</script>
<style>
    VmInclude:__COMPONENT__/grid/grid.v3.css
</style>
