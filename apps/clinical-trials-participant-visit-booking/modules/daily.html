<section>
	VmInclude:__COMPONENT__/calendar/day.v5.html
    <span style='font-size:60%'>Click the "Time header" to create an evend.</span>
</section>
<script>
    function F__ID(){
    	//--------------------------------------------------------
    	VmInclude:__COMPONENT__/calendar/day.v5.js
    	//--------------------------------------------------------
        var this_module         =$vm.module_list[$vm.vm['__ID'].name];
        var prefix              =this_module.prefix; if(prefix==undefined) prefix="";
        var booking_form        =prefix+this_module.booking_form;
    	var booking_record_tid	=this_module.table_id;
    	//--------------------------------------------------------
    	_request_and_render=function(){
            //jQuery.ajaxSetup({async:false});
    	    layout_render();
            //jQuery.ajaxSetup({async:true});
    	}
    	//--------------------------------------------------------
    	var layout_render=function(){
            var txt="<tr>";
        	for(var j=0;j<12;j++){
    			txt+="<th colspan=12 style='width:8%;cursor:pointer'>"+$vm.pad((8+j),2)+":00</th>";
    		}
    		txt+="</tr>";
            $('#thead__ID').html(txt);
    		txt="<tr><td colspan=144></td></tr>";
    		$('#tbody__ID').html(txt);
            put_on_click_for_create_booking();
            put_on_bookings();
    	};
    	//-----------------------------------
    	var put_on_click_for_create_booking=function(){
            $('#thead__ID th').each(function(){
    		    $(this).on('click',function(){
                    var record={
                        Date:$('#date__ID').val(),
                        Time:$(this).html()
                    }
                    $vm.load_module_v2(booking_form,"",{record:record,goback:1});
    		    });
    		});
    	};
    	//-----------------------------------
		var put_on_bookings=function(){
        	var sql="select ID,V1,Information from [TABLE-"+booking_record_tid+"] where DT1=@T1 order by S1";
            $VmAPI.request({data:{cmd:'query_records',sql:sql,t1:$('#date__ID').val()},callback:function(res){
        		for(var i=0;i<res.records.length;i++){
        			var cc="#EEEEEE"; if(i%2===0) cc="#ffffff";
                    var rid         =res.records[i].ID;
                    var time    	=res.records[i].Time;
                    var Participant =res.records[i].Participant;
                    var duration_0  =res.records[i].V1;
                    var color       =res.records[i].Color;
                    var aa            =time.split(':');
                    var startmargin =100*(parseInt(aa[0])+(parseInt(aa[1])/60)-8)/12;
                    var duration    =100*parseInt(duration_0)/720;

        			var txt="<div style='background-color:"+cc+";position: relative;'>";
                    txt+="<div style='position:relative;z-index:10;margin-left:"+startmargin+"%'><u id=B"+rid+" style='cursor:pointer'>"+$vm.time12(time)+"&nbsp;&nbsp;&nbsp;"+Participant+"</u></div>";
                    txt+="<div class=time__ID style='margin-left:"+startmargin+"%; width:"+duration+"%; background-color: "+color+"'>&nbsp;</div>";
                    txt+="</div>";
                    var $td=$('#table__ID').find('tbody tr:last').find('td').eq(0);
        			$td.append(txt);
                    $('#B'+rid).data('rid',rid);
                    $('#B'+rid).on('click',on_click_edit_fun);
        		}
    		}});
        };
    	//-----------------------------------
    	var on_click_edit_fun=function(){
    	    var rid=$(this).data('rid');
            var sql="select ID,Information from [TABLE-"+booking_record_tid+"] where ID=@I1";
            $VmAPI.request({data:{cmd:'query_records',sql:sql,i1:rid},callback:function(res){
                if(res.records.length==1){
                    res.records[0].Date=$vm.au_date_to_string_yyyymmdd(res.records[0].Date); //convert the existed date to the new standard format
                    $vm.load_module_v2(booking_form,'',{record:res.records[0],goback:1});
                }
            }});
    	};
    	//--------------------------------------------------------
    	$('#D__ID').on('load',function(){
            /*
            var d=$vm.date_to_string_dmy($vm.date_today());
            if($('#date__ID').val()!='') d=$('#date__ID').val();
            if($vm.vm['__ID'].input!=undefined && $vm.vm['__ID'].input.day!=undefined) d=$vm.vm['__ID'].input.day;
    	    $('#date__ID').val(d);
    	    $('#date__ID').triggerHandler('change');
            */
            var d=undefined;
            if($vm.vm['__ID'].input!=undefined) d=$vm.vm['__ID'].input.day;
    	    if(d!=undefined) $('#date__ID').val(d);
    	    $('#date__ID').triggerHandler('change');
    	});
    	//--------------------------------------------------------
        $('#D__ID').on('show',function(){if($vm.refresh==1){$vm.refresh=0;_request_and_render();}});
    	//--------------------------------------------------------
    }
</script>
<style>
	#D__ID{
	    background-color:#fff;
	    font-size:13px;
	    font-family: Helvetica, Arial, sans-serif;
		height:100%;
		overflow: auto;
	}
	.time__ID{
    	margin-bottom:2px;
    	border-radius:3px;
    	box-shadow: 3px 3px 2px #888;
    	text-align:left;
        z-index:9;
        top:0;
        position:absolute;
    }
</style>
