<section>
	<button id=run__ID type=button>Test</button><span id=aaa></span>
    VmInclude:__PARTS__/grid/grid.v3.html
</section>
<script>
    function F__ID(){
        //-------------------------------------
        VmInclude:__PARTS__/grid/grid.v3.js
		_json='';
        //-------------------------------------
		_fields="_Form,Volunteer ID|UID,Project,Match,Reg,Status,First_Name,Last_Name,Phone,Postcode,Email,Medical_Research,Newsletters,Gender,Year_of_Birth,Asthma,COPD,Chronic_Bronchitis,Emphysema,Rhintis,Lung_Cancer,Insomnia,Narcolepsy,OSA,RLS";
        _fields+=",Submit Date|DateTime,_Delete";
        //-------------------------------------
		$('#D__ID').on('load',function(){
            _set_req(); _request_data();
        })
		$('#run__ID').on('click',function(){
			jQuery.ajaxSetup({async:false});
			for(var i=0;i<_records.length;i++){
				var regs="";
				var sql="select S1 from [TABLE-20009681] where S2='system_20008533_"+_records[i].S2+"'";
				var req={cmd:'query_records',sql:sql};
				$VmAPI.request({data:req,callback:function(res){
					for(var j=0;j<res.records.length;j++){
						var REG=res.records[j].S1;
						if(regs!="") regs+=",";
						regs+=REG;
					}
				}});
				_records[i].Reg=regs;

				var status="";
				var sql="select S1,S3 from [TABLE-20011360] where PUID="+_records[i].UID;
				var req={cmd:'query_records',sql:sql};
				$VmAPI.request({data:req,callback:function(res){
					for(var j=0;j<res.records.length;j++){
						var STS=res.records[j].S1+"/"+res.records[j].S3;
						if(status!="") status+=",";
						status+=STS;
					}
				}});
				_records[i].Status=status;
			}
			var sql="select S3,V1,V2,Information from [TABLE-20009716]";
			var req={cmd:'query_records',sql:sql};
            $VmAPI.request({data:req,callback:function(res){
				for(var i=0;i<_records.length;i++){
					var match="";
					for(var k=0;k<res.records.length;k++){
						var rd=res.records[k]
						var P_V1=rd.V1;
						var P_V2=rd.V2;
						var INC=(P_V1==(P_V1&_records[i].R_V1));
						var EXC=((P_V2&_records[i].R_V1)==0);
						if(INC==true && EXC==true){
							if(match!="") match+=",";
							match+=rd.S3;
                            /*
                            if(rd.S3=='severe_asthma'){
                                _records[i].A=P_V2;
                                _records[i].B=_records[i].R_V1;
                            }
                            */
						}
					}
					_records[i].Match=match;
				}
            }});
			jQuery.ajaxSetup({async:true});
			for(var i=0;i<_records.length;i++){
				var project="";
				var m=_records[i].Match.split(',');
				var r=_records[i].Reg.split(',');
				var s=_records[i].Status;;
				for(var j=0;j<m.length;j++){
					var ok=1;
					if(s.indexOf('Screening/')!=-1 && s.indexOf('Screening/'+m[j])==-1) ok=0;
					if(s.indexOf('Enrolled/')!=-1 && s.indexOf('Enrolled/'+m[j])==-1) ok=0;
					if(ok==1){
						if(project!="") project+=",";
						project+=m[j];
					}
				}
				for(var j=0;j<r.length;j++){
					var ok=1;
					if(s.indexOf('Screening/')!=-1 && s.indexOf('Screening/'+r[j])==-1) ok=0;
					if(s.indexOf('Enrolled/')!=-1 && s.indexOf('Enrolled/'+r[j])==-1) ok=0;
					if(ok==1){
						if(project.indexOf(r[j])==-1){
							if(project!="") project+=",";
							project+=r[j];
						}
					}
				}
                for(var j=0;j<s.length;j++){
					var ok=1;
                    var ss=s.split('Screening/');
                    if(ss.length>1){
                        for(var x=1;x<ss.length;x++){
                            var sss=ss[x].split(',')[0];
                            if(project.indexOf(sss)==-1){
    							if(project!="") project+=",";
    							project+=sss;
    						}
                        }
                    }
                    var ss=s.split('Enrolled/');
                    if(ss.length>1){
                        for(var x=1;x<ss.length;x++){
                            var sss=ss[x].split(',')[0];
                            if(project.indexOf(sss)==-1){
    							if(project!="") project+=",";
    							project+=sss;
    						}
                        }
                    }
				}
				_records[i].Project=project;
			}
            for(var i=0;i<_records.length;i++){
                if(_records[i].Project!='') _records[i].Project="p_"+_records[i].Project.replace(/,/g,',p_');
                if(_records[i].Match!='') _records[i].Match="m_"+_records[i].Match.replace(/,/g,',m_');
                if(_records[i].Reg!='') _records[i].Reg="r_"+_records[i].Reg.replace(/,/g,',r_');
                if(_records[i].Status!='') _records[i].Status="s_"+_records[i].Status.replace(/,/g,',s_');
            }
			_render();
		})
		//-------------------------------------
		var _set_req=function(){
		    var sql="with tb as (select S2,Age=DATEDIFF(year, DT1,GetDate()),R_V1=convert(int,V1),Information,ID,UID,PUID,DateTime,Modified=Convert(varchar,Modified,127),Author,RowNum=row_number() over (order by ID DESC) from [TABLE-"+_db_pid+"-@S1] where B1=1 )";
		    sql+="select S2,Age,R_V1,Information,ID,UID,PUID,DateTime,Modified,Author,RowNum from tb where RowNum between @I6 and @I7";
		    var sql_n="select count(ID) from [TABLE-"+_db_pid+"-@S1]";
			_req={cmd:'query_records',db_pid:_db_pid,sql:sql,sql_n:sql_n,s1:'"'+$('#keyword__ID').val()+'"',I:$('#I__ID').text(),page_size:$('#page_size__ID').val()}
		}
		//-------------------------------------
    }
</script>
<style>
    VmInclude:__PARTS__/grid/grid.v3.css
</style>
